"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FactoryMapCollection = exports.FactoryMap = exports.ReplaceType = void 0;
const tslib_1 = require("tslib");
const _ = tslib_1.__importStar(require("lodash"));
var Path = require('path');
const parse_esnext_import_1 = require("./parse-esnext-import");
/** // TODO */
var ReplaceType;
(function (ReplaceType) {
    ReplaceType[ReplaceType["rq"] = 0] = "rq";
    ReplaceType[ReplaceType["ima"] = 1] = "ima";
    ReplaceType[ReplaceType["imp"] = 2] = "imp";
    ReplaceType[ReplaceType["rs"] = 3] = "rs"; // require.ensure()
})(ReplaceType = exports.ReplaceType || (exports.ReplaceType = {}));
class FactoryMap {
    // static METHODS: string[] = ['factory', 'substitute', 'value', 'swigTemplateDir', 'replaceCode', 'variable'];
    constructor(config) {
        this.requireMap = {};
        this.beginWithSearch = []; // Binary search
        this.regexSettings = [];
        this.beginWithSorted = false;
        this.resolvePaths = null;
        if (config === undefined)
            this.config = {};
        else
            this.config = config;
    }
    factory(requiredModule, factoryFunc) {
        return this._addSetting('factory', requiredModule, factoryFunc);
    }
    substitute(requiredModule, newModule) {
        return this._addSetting('substitute', requiredModule, newModule);
    }
    value(requiredModule, newModule) {
        return this._addSetting('value', requiredModule, newModule);
    }
    swigTemplateDir(requiredModule, dir) {
        return this._addSetting('swigTemplateDir', requiredModule, dir);
    }
    replaceCode(requiredModule, newModule) {
        return this._addSetting('replaceCode', requiredModule, newModule);
    }
    alias(requiredModule, newModule) {
        return this._addSetting('substitute', requiredModule, newModule);
    }
    // asInterface() {
    // 	return ((this as any) as FactoryMapInterf & FactoryMap);
    // }
    getInjector(name) {
        return this.matchRequire(name);
    }
    // you can extend with new method here
    matchRequire(name) {
        if (!name)
            return null;
        var webpackLoaderPrefix = '';
        var webpackLoaderIdx = name.lastIndexOf('!');
        if (webpackLoaderIdx >= 0) {
            webpackLoaderPrefix = name.substring(0, webpackLoaderIdx + 1);
            name = name.substring(webpackLoaderIdx + 1);
        }
        let setting;
        if (_.has(this.requireMap, name)) {
            setting = _.extend({}, this.requireMap[name]);
            setting.prefix = webpackLoaderPrefix;
            return setting;
        }
        else {
            const isPackage = !_.startsWith(name, '.') && !Path.isAbsolute(name);
            if (isPackage && (_.startsWith(name, '@') || name.indexOf('/') > 0)) {
                var m = /^((?:@[^\/]+\/)?[^\/]+)(\/.+?)?$/.exec(name);
                if (m && _.has(this.requireMap, m[1])) {
                    setting = _.extend({}, this.requireMap[m[1]]);
                    setting.subPath = m[2];
                    setting.prefix = webpackLoaderPrefix;
                    return setting;
                }
            }
            let foundReg = _.find(this.regexSettings, s => {
                s.execResult = s.regex.exec(name) || undefined;
                return s.execResult != null;
            });
            if (foundReg) {
                foundReg = _.extend({}, foundReg);
                foundReg.prefix = webpackLoaderPrefix;
                return foundReg;
            }
            return null;
        }
    }
    /**
     *
     * @param  {any} factorySetting matchRequire() returned value
     * @param  {ReplaceType} type       "rq" for "require()", "rs" for "require.ensure"
     * @param  {string} fileParam  current replacing file path
     * @return {string}            replacement text
     */
    getReplacement(factorySetting, type, fileParam, info) {
        if (!factorySetting)
            throw new Error('This is require-injector\' fault, error due to null factorySetting, tell author about it.');
        return replaceActions[factorySetting.method].call(this, factorySetting.value, type, fileParam, factorySetting.execResult, info, factorySetting.prefix, factorySetting.subPath);
    }
    getInjected(factorySetting, calleeModuleId, calleeModule, requireCall) {
        if (!factorySetting)
            throw new Error('This is require-injector\'s fault, error due to null factorySetting, tell author about it.');
        return injectActions[factorySetting.method].call(this, factorySetting.value, calleeModuleId, calleeModule, requireCall, factorySetting.subPath);
    }
    addResolvePath(dir) {
        if (this.resolvePaths == null)
            this.resolvePaths = [];
        this.resolvePaths.push(dir);
        return this;
    }
    _addSetting(method, name, value) {
        if (_.isRegExp(name)) {
            this.regexSettings.push({
                regex: name,
                method,
                value,
                subPath: '',
                prefix: ''
            });
        }
        else {
            this.requireMap[name] = {
                method,
                value,
                subPath: '',
                prefix: ''
            };
        }
        return this;
    }
}
exports.FactoryMap = FactoryMap;
let replaceActions = {
    factory(value, type, fileParam, execResult, astInfo, prefix, subPath) {
        const sourcePath = JSON.stringify(this.config.enableFactoryParamFile ? fileParam : '');
        const execFactory = '(' + value.toString() + ')(' + sourcePath +
            (execResult ? ',' + JSON.stringify(execResult) : '') + ')';
        if (type === ReplaceType.rq || type === ReplaceType.ima) { // for require() or import()
            return execFactory;
        }
        else if (type === ReplaceType.imp) {
            return {
                replaceAll: true,
                code: parse_esnext_import_1.toAssignment(astInfo, execFactory)
            };
        }
        return null;
    },
    substitute(setting, type, fileParam, execResult, astInfo, prefix, subPath) {
        if (type === ReplaceType.rs) { // for require.ensure
            if (_.isFunction(setting))
                return JSON.stringify(setting(fileParam, execResult) + subPath);
            return JSON.stringify(setting + subPath);
        }
        else if (type === ReplaceType.rq) {
            if (_.isFunction(setting))
                return 'require(' + JSON.stringify(prefix + setting(fileParam, execResult)) + subPath + ')';
            return 'require(' + JSON.stringify(prefix + setting + subPath) + ')';
        }
        else if (type === ReplaceType.ima) {
            if (_.isFunction(setting))
                return 'import(' + JSON.stringify(prefix + setting(fileParam, execResult)) + subPath + ')';
            return 'import(' + JSON.stringify(prefix + setting) + subPath + ')';
        }
        else if (type === ReplaceType.imp) {
            var replaced = _.isFunction(setting) ? setting(fileParam, execResult) : setting;
            replaced = JSON.stringify(prefix + replaced + subPath);
            return {
                replaceAll: false,
                code: replaced
            };
        }
        return null;
    },
    value(setting, type, fileParam, execResult, astInfo, prefix, subPath) {
        if (type === ReplaceType.rq || type === ReplaceType.imp || type === ReplaceType.ima) {
            var replaced;
            if (_.has(setting, 'replacement')) {
                const setting1 = setting;
                replaced = (_.isFunction(setting1.replacement)) ?
                    setting1.replacement(fileParam, execResult) :
                    setting1.replacement;
            }
            else {
                replaced = _.isFunction(setting) ? JSON.stringify(setting(fileParam, execResult)) :
                    JSON.stringify(setting);
            }
            return type === ReplaceType.imp ? {
                replaceAll: true,
                code: parse_esnext_import_1.toAssignment(astInfo, replaced)
            } : replaced;
        }
        return null;
    },
    replaceCode(setting, type, fileParam, execResult, astInfo, prefix, subPath) {
        var replaced = setting;
        if (_.isFunction(setting))
            replaced = setting(fileParam, execResult);
        return type === ReplaceType.imp ? {
            replaceAll: true,
            code: parse_esnext_import_1.toAssignment(astInfo, replaced)
        } : replaced;
    },
    variable(setting, type, fileParam, execResult, astInfo) {
        if (type === ReplaceType.rq || type === ReplaceType.ima) {
            return setting;
        }
        if (type === ReplaceType.imp)
            return {
                replaceAll: true,
                code: parse_esnext_import_1.toAssignment(astInfo, setting)
            };
        return null;
    }
    // resolvePath(dir: FactorySetting, type: string, fileParam: string, execResult: RegExpExecArray,
    // 	astInfo: ParseInfo): string {
    // 	return dir as string;
    // }
};
let injectActions = {
    factory(setting, calleeModuleId, calleeModule, requireCall, subPath) {
        if (_.isFunction(setting)) {
            return setting(calleeModuleId);
        }
        else {
            return setting;
        }
    },
    value(setting, calleeModuleId, calleeModule, requireCall, subPath) {
        if (_.has(setting, 'value'))
            return setting.value;
        else
            return setting;
    },
    replaceCode(setting, calleeModuleId, calleeModule, requireCall, subPath) {
        // tslint:disable-next-line:no-console
        console.log('require-injector does not support "replaceCode()" for NodeJS environment');
    },
    substitute(setting, calleeModuleId, calleeModule, requireCall, subPath) {
        return requireCall.call(calleeModule, setting + subPath);
    },
    variable(setting, calleeModuleId, calleeModule, requireCall, subPath) {
        return setting;
    }
};
class FactoryMapCollection {
    constructor(maps) {
        this.maps = maps;
    }
    factory(requiredModule, factoryFunc) {
        return this._addSetting('factory', requiredModule, factoryFunc);
    }
    substitute(requiredModule, newModule) {
        return this._addSetting('substitute', requiredModule, newModule);
    }
    value(requiredModule, newModule) {
        return this._addSetting('value', requiredModule, newModule);
    }
    swigTemplateDir(requiredModule, dir) {
        return this._addSetting('swigTemplateDir', requiredModule, dir);
    }
    replaceCode(requiredModule, newModule) {
        return this._addSetting('replaceCode', requiredModule, newModule);
    }
    alias(requiredModule, newModule) {
        return this._addSetting('substitute', requiredModule, newModule);
    }
    _addSetting(method, requiredModule, newModule) {
        for (const factoryMap of this.maps) {
            factoryMap._addSetting(method, requiredModule, newModule);
        }
        return this;
    }
}
exports.FactoryMapCollection = FactoryMapCollection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmFjdG9yeS1tYXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi90cy9mYWN0b3J5LW1hcC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBRUEsa0RBQTRCO0FBQzVCLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQiwrREFBbUQ7QUFtQm5ELGNBQWM7QUFDZCxJQUFZLFdBS1g7QUFMRCxXQUFZLFdBQVc7SUFDdEIseUNBQUssQ0FBQTtJQUNMLDJDQUFHLENBQUE7SUFDSCwyQ0FBRyxDQUFBO0lBQ0gseUNBQUUsQ0FBQSxDQUFDLG1CQUFtQjtBQUN2QixDQUFDLEVBTFcsV0FBVyxHQUFYLG1CQUFXLEtBQVgsbUJBQVcsUUFLdEI7QUF5QkQsTUFBYSxVQUFVO0lBT3RCLCtHQUErRztJQUUvRyxZQUFZLE1BQWU7UUFQM0IsZUFBVSxHQUFrQyxFQUFFLENBQUM7UUFDL0Msb0JBQWUsR0FBVSxFQUFFLENBQUMsQ0FBQyxnQkFBZ0I7UUFDN0Msa0JBQWEsR0FBbUIsRUFBRSxDQUFDO1FBQ25DLG9CQUFlLEdBQVksS0FBSyxDQUFDO1FBQ3pCLGlCQUFZLEdBQW9CLElBQUksQ0FBQztRQUk1QyxJQUFJLE1BQU0sS0FBSyxTQUFTO1lBQ3ZCLElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxDQUFDOztZQUVqQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztJQUN2QixDQUFDO0lBRUQsT0FBTyxDQUFDLGNBQStCLEVBQUUsV0FBd0I7UUFDaEUsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLFNBQVMsRUFBRSxjQUFjLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVELFVBQVUsQ0FBQyxjQUErQixFQUFFLFNBQThCO1FBQ3pFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLEVBQUUsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2xFLENBQUM7SUFDRCxLQUFLLENBQUMsY0FBK0IsRUFB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Q0FBQztJQUVELFdBQVcsQ0FBQyxjQUErQixFQUFFLFNBQThCO1FBQzFFLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxhQUFhLEVBQUUsY0FBYyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ25FLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBK0IsRUFBRSxTQUE4QjtRQUNwRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLGNBQWMsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBQ1MsV0FBVyxDQUE2QixNQUFjLEVBQUUsY0FBK0IsRUFBRSxTQUE4QjtRQUNoSSxLQUFLLE1BQU0sVUFBVSxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDbEMsVUFBeUIsQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLGNBQWMsRUFBRSxTQUFTLENBQUMsQ0FBQztTQUMxRTtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztDQUNEO0FBakNELG9EQWlDQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRzbGludDpkaXNhYmxlIG1heC1saW5lLWxlbmd0aFxuaW1wb3J0IHtQYXJzZUluZm8sIFBhcnNlRXhwb3J0SW5mb30gZnJvbSAnLi9wYXJzZS1lc25leHQtaW1wb3J0JztcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcbnZhciBQYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuaW1wb3J0IHt0b0Fzc2lnbm1lbnR9IGZyb20gJy4vcGFyc2UtZXNuZXh0LWltcG9ydCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29uZmlnIHtcblx0W2tleTogc3RyaW5nXTogYW55O1xuXHRlbmFibGVGYWN0b3J5UGFyYW1GaWxlPzogYm9vbGVhbiB8IHVuZGVmaW5lZDtcbn1cbmV4cG9ydCBpbnRlcmZhY2UgRmFjdG9yeVNldHRpbmcge1xuXHRtZXRob2Q6IGtleW9mIFJlcGxhY2VBY3Rpb25zO1xuXHRwcmVmaXg6IHN0cmluZztcblx0dmFsdWU/OiBGYWN0b3J5RnVuYyB8IGFueTtcblx0ZXhlY1Jlc3VsdD86IFJlZ0V4cEV4ZWNBcnJheTtcblx0c3ViUGF0aD86IHN0cmluZztcblx0cmVwbGFjZW1lbnQ/OiAoZmlsZTogc3RyaW5nLCBleGVjUmVzdWx0OiBSZWdFeHBFeGVjQXJyYXkpID0+IGFueSB8IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZXBsYWNlVHlwZVZhbHVlIHtcblx0cmVwbGFjZW1lbnQ6IHN0cmluZztcblx0dmFsdWU6IGFueSB8IEZhY3RvcnlGdW5jO1xufVxuLyoqIC8vIFRPRE8gKi9cbmV4cG9ydCBlbnVtIFJlcGxhY2VUeXBlIHtcblx0cnE9IDAsIC8vIHJlcXVpcmUoKVxuXHRpbWEsIC8vIGltcG9ydCgpXG5cdGltcCwgLy8gaW1wb3J0IGV4cHJlc3Npb25cblx0cnMgLy8gcmVxdWlyZS5lbnN1cmUoKVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlZ2V4U2V0dGluZyBleHRlbmRzIEZhY3RvcnlTZXR0aW5nIHtcblx0cmVnZXg6IFJlZ0V4cDtcbn1cblxuLy8gZXhwb3J0IHR5cGUgRmFjdG9yeVNldHRpbmcgPSBGYWN0b3J5U2V0dGluZ09iajtcblxuZXhwb3J0IGludGVyZmFjZSBSZXBsYWNlZFJlc3VsdCB7cmVwbGFjZUFsbDogYm9vbGVhbjsgY29kZTogc3RyaW5nO31cbmludGVyZmFjZSBSZXBsYWNlQWN0aW9ucyB7XG5cdFttZXRob2Q6IHN0cmluZ106ICh0aGlzOiBGYWN0b3J5TWFwLCByZXBsYWNlV2l0aDogRmFjdG9yeUZ1bmMgfCBhbnksIHR5cGU6IFJlcGxhY2VUeXBlLCBmaWxlUGFyYW06IHN0cmluZywgZXhlY1Jlc3VsdDogUmVnRXhwRXhlY0FycmF5LFxuXHRcdGFzdEluZm86IFBhcnNlSW5mbywgcHJlZml4PzogYW55LCBzdWJQYXRoPzogc3RyaW5nKSA9PiBudWxsIHwgc3RyaW5nIHwgUmVwbGFjZWRSZXN1bHQ7XG59XG5cbmludGVyZmFjZSBJbmplY3RBY3Rpb25zIHtcblx0W21ldGhvZDogc3RyaW5nXTogSW5qZWN0QWN0aW9uRnVuYztcbn1cbnR5cGUgSW5qZWN0QWN0aW9uRnVuYyA9ICh0aGlzOiBGYWN0b3J5TWFwLCB2YWx1ZTogRmFjdG9yeUZ1bmMgfCBhbnksXG5cdGNhbGxlZU1vZHVsZUlkOiBzdHJpbmcsXG5cdGNhbGxlZU1vZHVsZTogYW55LFxuXHRyZXF1aXJlQ2FsbDogKG06IGFueSwgZmlsZTogc3RyaW5nKSA9PiBGYWN0b3J5U2V0dGluZyxcblx0c3ViUGF0aD86IHN0cmluZykgPT4gRmFjdG9yeVNldHRpbmc7XG5cbmV4cG9ydCB0eXBlIEZhY3RvcnlGdW5jID0gKHNvdXJjZUZpbGVQYXRoOiBzdHJpbmcsIHJlZ2V4cEV4ZWNSZXN1bHQ/OiBSZWdFeHBFeGVjQXJyYXkpID0+IGFueTtcblxuZXhwb3J0IGNsYXNzIEZhY3RvcnlNYXAgaW1wbGVtZW50cyBGYWN0b3J5TWFwSW50ZXJmIHtcblx0Y29uZmlnOiBDb25maWc7XG5cdHJlcXVpcmVNYXA6IHtbazogc3RyaW5nXTogRmFjdG9yeVNldHRpbmd9ID0ge307XG5cdGJlZ2luV2l0aFNlYXJjaDogYW55W10gPSBbXTsgLy8gQmluYXJ5IHNlYXJjaFxuXHRyZWdleFNldHRpbmdzOiBSZWdleFNldHRpbmdbXSA9IFtdO1xuXHRiZWdpbldpdGhTb3J0ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblx0cHJpdmF0ZSByZXNvbHZlUGF0aHM6IHN0cmluZ1tdIHwgbnVsbCA9IG51bGw7XG5cdC8vIHN0YXRpYyBNRVRIT0RTOiBzdHJpbmdbXSA9IFsnZmFjdG9yeScsICdzdWJzdGl0dXRlJywgJ3ZhbHVlJywgJ3N3aWdUZW1wbGF0ZURpcicsICdyZXBsYWNlQ29kZScsICd2YXJpYWJsZSddO1xuXG5cdGNvbnN0cnVjdG9yKGNvbmZpZz86IENvbmZpZykge1xuXHRcdGlmIChjb25maWcgPT09IHVuZGVmaW5lZClcblx0XHRcdHRoaXMuY29uZmlnID0ge307XG5cdFx0ZWxzZVxuXHRcdFx0dGhpcy5jb25maWcgPSBjb25maWc7XG5cdH1cblxuXHRmYWN0b3J5KHJlcXVpcmVkTW9kdWxlOiBzdHJpbmcgfCBSZWdFeHAsIGZhY3RvcnlGdW5jOiBGYWN0b3J5RnVuYyk6IEZhY3RvcnlNYXBJbnRlcmYge1xuXHRcdHJldHVybiB0aGlzLl9hZGRTZXR0aW5nKCdmYWN0b3J5JywgcmVxdWlyZWRNb2R1bGUsIGZhY3RvcnlGdW5jKTtcblx0fVxuXG5cdHN1YnN0aXR1dGUocmVxdWlyZWRNb2R1bGU6IHN0cmluZyB8IFJlZ0V4cCwgbmV3TW9kdWxlOiBzdHJpbmd8IEZhY3RvcnlGdW5jKTogRmFjdG9yeU1hcEludGVyZiB7XG5cdFx0cmV0dXJuIHRoaXMuX2FkZFNldHRpbmcoJ3N1YnN0aXR1dGUnLCByZXF1aXJlZE1vZHVsZSwgbmV3TW9kdWxlKTtcblx0fVxuXHR2YWx1ZShyZXF1aXJlZE1vZHVsZTogc3RyaW5nIHwgUmVnRXhwLCBuZXdNb2R1bGU6IHtyZXBsYWNlbWVudDogYW55fXwgRmFjdG9yeUZ1bmMgfCBhbnkpOiBGYWN0b3J5TWFwSW50ZXJmIHtcblx0XHRyZXR1cm4gdGhpcy5fYWRkU2V0dGluZygndmFsdWUnLCByZXF1aXJlZE1vZHVsZSwgbmV3TW9kdWxlKTtcblx0fVxuXG5cdHN3aWdUZW1wbGF0ZURpcihyZXF1aXJlZE1vZHVsZTogc3RyaW5nLCBkaXI6IHN0cmluZyk6IEZhY3RvcnlNYXBJbnRlcmYge1xuXHRcdHJldHVybiB0aGlzLl9hZGRTZXR0aW5nKCdzd2lnVGVtcGxhdGVEaXInLCByZXF1aXJlZE1vZHVsZSwgZGlyKTtcblx0fVxuXG5cdHJlcGxhY2VDb2RlKHJlcXVpcmVkTW9kdWxlOiBzdHJpbmcgfCBSZWdFeHAsIG5ld01vZHVsZTogc3RyaW5nfCBGYWN0b3J5RnVuYyk6IEZhY3RvcnlNYXBJbnRlcmYge1xuXHRcdHJldHVybiB0aGlzLl9hZGRTZXR0aW5nKCdyZXBsYWNlQ29kZScsIHJlcXVpcmVkTW9kdWxlLCBuZXdNb2R1bGUpO1xuXHR9XG5cblx0YWxpYXMocmVxdWlyZWRNb2R1bGU6IHN0cmluZyB8IFJlZ0V4cCwgbmV3TW9kdWxlOiBzdHJpbmd8IEZhY3RvcnlGdW5jKTogRmFjdG9yeU1hcEludGVyZiB7XG5cdFx0cmV0dXJuIHRoaXMuX2FkZFNldHRpbmcoJ3N1YnN0aXR1dGUnLCByZXF1aXJlZE1vZHVsZSwgbmV3TW9kdWxlKTtcblx0fVxuXHQvLyBhc0ludGVyZmFjZSgpIHtcblx0Ly8gXHRyZXR1cm4gKCh0aGlzIGFzIGFueSkgYXMgRmFjdG9yeU1hcEludGVyZiAmIEZhY3RvcnlNYXApO1xuXHQvLyB9XG5cblx0Z2V0SW5qZWN0b3IobmFtZTogc3RyaW5nKTogRmFjdG9yeVNldHRpbmcgfCBudWxsIHtcblx0XHRyZXR1cm4gdGhpcy5tYXRjaFJlcXVpcmUobmFtZSk7XG5cdH1cblx0Ly8geW91IGNhbiBleHRlbmQgd2l0aCBuZXcgbWV0aG9kIGhlcmVcblxuXHRtYXRjaFJlcXVpcmUobmFtZTogc3RyaW5nKTogRmFjdG9yeVNldHRpbmcgfCBudWxsIHtcblx0XHRpZiAoIW5hbWUpXG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR2YXIgd2VicGFja0xvYWRlclByZWZpeCA9ICcnO1xuXHRcdHZhciB3ZWJwYWNrTG9hZGVySWR4ID0gbmFtZS5sYXN0SW5kZXhPZignIScpO1xuXHRcdGlmICh3ZWJwYWNrTG9hZGVySWR4ID49IDApIHtcblx0XHRcdHdlYnBhY2tMb2FkZXJQcmVmaXggPSBuYW1lLnN1YnN0cmluZygwLCB3ZWJwYWNrTG9hZGVySWR4ICsgMSk7XG5cdFx0XHRuYW1lID0gbmFtZS5zdWJzdHJpbmcod2VicGFja0xvYWRlcklkeCArIDEpO1xuXHRcdH1cblxuXHRcdGxldCBzZXR0aW5nOiBGYWN0b3J5U2V0dGluZztcblx0XHRpZiAoXy5oYXModGhpcy5yZXF1aXJlTWFwLCBuYW1lKSkge1xuXHRcdFx0c2V0dGluZyA9IF8uZXh0ZW5kKHt9LCB0aGlzLnJlcXVpcmVNYXBbbmFtZV0pO1xuXHRcdFx0c2V0dGluZy5wcmVmaXggPSB3ZWJwYWNrTG9hZGVyUHJlZml4O1xuXHRcdFx0cmV0dXJuIHNldHRpbmc7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGNvbnN0IGlzUGFja2FnZSA9ICFfLnN0YXJ0c1dpdGgobmFtZSwgJy4nKSAmJiAhUGF0aC5pc0Fic29sdXRlKG5hbWUpO1xuXHRcdFx0aWYgKGlzUGFja2FnZSAmJiAoXy5zdGFydHNXaXRoKG5hbWUsICdAJykgfHwgbmFtZS5pbmRleE9mKCcvJykgPiAwKSkge1xuXHRcdFx0XHR2YXIgbSA9IC9eKCg/OkBbXlxcL10rXFwvKT9bXlxcL10rKShcXC8uKz8pPyQvLmV4ZWMobmFtZSk7XG5cdFx0XHRcdGlmIChtICYmIF8uaGFzKHRoaXMucmVxdWlyZU1hcCwgbVsxXSkpIHtcblx0XHRcdFx0XHRzZXR0aW5nID0gXy5leHRlbmQoe30sIHRoaXMucmVxdWlyZU1hcFttWzFdXSk7XG5cdFx0XHRcdFx0c2V0dGluZy5zdWJQYXRoID0gbVsyXTtcblx0XHRcdFx0XHRzZXR0aW5nLnByZWZpeCA9IHdlYnBhY2tMb2FkZXJQcmVmaXg7XG5cdFx0XHRcdFx0cmV0dXJuIHNldHRpbmc7XG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHRcdGxldCBmb3VuZFJlZyA9ICBfLmZpbmQodGhpcy5yZWdleFNldHRpbmdzLCBzID0+IHtcblx0XHRcdFx0cy5leGVjUmVzdWx0ID0gcy5yZWdleC5leGVjKG5hbWUpIHx8IHVuZGVmaW5lZDtcblx0XHRcdFx0cmV0dXJuIHMuZXhlY1Jlc3VsdCAhPSBudWxsO1xuXHRcdFx0fSk7XG5cdFx0XHRpZiAoZm91bmRSZWcpIHtcblx0XHRcdFx0Zm91bmRSZWcgPSBfLmV4dGVuZCh7fSwgZm91bmRSZWcpO1xuXHRcdFx0XHRmb3VuZFJlZy5wcmVmaXggPSB3ZWJwYWNrTG9hZGVyUHJlZml4O1xuXHRcdFx0XHRyZXR1cm4gZm91bmRSZWc7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gbnVsbDtcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICpcblx0ICogQHBhcmFtICB7YW55fSBmYWN0b3J5U2V0dGluZyBtYXRjaFJlcXVpcmUoKSByZXR1cm5lZCB2YWx1ZVxuXHQgKiBAcGFyYW0gIHtSZXBsYWNlVHlwZX0gdHlwZSAgICAgICBcInJxXCIgZm9yIFwicmVxdWlyZSgpXCIsIFwicnNcIiBmb3IgXCJyZXF1aXJlLmVuc3VyZVwiXG5cdCAqIEBwYXJhbSAge3N0cmluZ30gZmlsZVBhcmFtICBjdXJyZW50IHJlcGxhY2luZyBmaWxlIHBhdGhcblx0ICogQHJldHVybiB7c3RyaW5nfSAgICAgICAgICAgIHJlcGxhY2VtZW50IHRleHRcblx0ICovXG5cdGdldFJlcGxhY2VtZW50KGZhY3RvcnlTZXR0aW5nOiBGYWN0b3J5U2V0dGluZywgdHlwZTogUmVwbGFjZVR5cGUsIGZpbGVQYXJhbTogc3RyaW5nLCBpbmZvPzogUGFyc2VJbmZvIHwgUGFyc2VFeHBvcnRJbmZvKTogc3RyaW5nIHwgUmVwbGFjZWRSZXN1bHQgfCBudWxsIHtcblx0XHRpZiAoIWZhY3RvcnlTZXR0aW5nKVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKCdUaGlzIGlzIHJlcXVpcmUtaW5qZWN0b3JcXCcgZmF1bHQsIGVycm9yIGR1ZSB0byBudWxsIGZhY3RvcnlTZXR0aW5nLCB0ZWxsIGF1dGhvciBhYm91dCBpdC4nKTtcblx0XHRyZXR1cm4gcmVwbGFjZUFjdGlvbnNbZmFjdG9yeVNldHRpbmcubWV0aG9kXS5jYWxsKHRoaXMsXG5cdFx0XHRmYWN0b3J5U2V0dGluZy52YWx1ZSwgdHlwZSwgZmlsZVBhcmFtLCBmYWN0b3J5U2V0dGluZy5leGVjUmVzdWx0LFxuXHRcdFx0aW5mbywgZmFjdG9yeVNldHRpbmcucHJlZml4LCBmYWN0b3J5U2V0dGluZy5zdWJQYXRoKTtcblx0fVxuXG5cdGdldEluamVjdGVkKGZhY3RvcnlTZXR0aW5nOiBGYWN0b3J5U2V0dGluZywgY2FsbGVlTW9kdWxlSWQ6IHN0cmluZywgY2FsbGVlTW9kdWxlOiBhbnksXG5cdFx0cmVxdWlyZUNhbGw6IChtOiBhbnksIGZpbGU6IHN0cmluZykgPT4gRmFjdG9yeVNldHRpbmcpOiBhbnkge1xuXHRcdGlmICghZmFjdG9yeVNldHRpbmcpXG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ1RoaXMgaXMgcmVxdWlyZS1pbmplY3RvclxcJ3MgZmF1bHQsIGVycm9yIGR1ZSB0byBudWxsIGZhY3RvcnlTZXR0aW5nLCB0ZWxsIGF1dGhvciBhYm91dCBpdC4nKTtcblx0XHRyZXR1cm4gaW5qZWN0QWN0aW9uc1tmYWN0b3J5U2V0dGluZy5tZXRob2RdLmNhbGwodGhpcywgZmFjdG9yeVNldHRpbmcudmFsdWUsXG5cdFx0XHRjYWxsZWVNb2R1bGVJZCwgY2FsbGVlTW9kdWxlLCByZXF1aXJlQ2FsbCwgZmFjdG9yeVNldHRpbmcuc3ViUGF0aCk7XG5cdH1cblxuXHRhZGRSZXNvbHZlUGF0aChkaXI6IHN0cmluZykge1xuXHRcdGlmICh0aGlzLnJlc29sdmVQYXRocyA9PSBudWxsKVxuXHRcdFx0dGhpcy5yZXNvbHZlUGF0aHMgPSBbXTtcblx0XHR0aGlzLnJlc29sdmVQYXRocy5wdXNoKGRpcik7XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRfYWRkU2V0dGluZyh0aGlzOiBGYWN0b3J5TWFwLCBtZXRob2Q6IHN0cmluZywgbmFtZTogc3RyaW5nIHwgUmVnRXhwLCB2YWx1ZTogRmFjdG9yeUZ1bmMgfCBhbnkpIHtcblx0XHRpZiAoXy5pc1JlZ0V4cChuYW1lKSkge1xuXHRcdFx0dGhpcy5yZWdleFNldHRpbmdzLnB1c2goIHtcblx0XHRcdFx0cmVnZXg6IG5hbWUsXG5cdFx0XHRcdG1ldGhvZCxcblx0XHRcdFx0dmFsdWUsXG5cdFx0XHRcdHN1YlBhdGg6ICcnLFxuXHRcdFx0XHRwcmVmaXg6ICcnXG5cdFx0XHR9KTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5yZXF1aXJlTWFwW25hbWVdID0ge1xuXHRcdFx0XHRtZXRob2QsXG5cdFx0XHRcdHZhbHVlLFxuXHRcdFx0XHRzdWJQYXRoOiAnJyxcblx0XHRcdFx0cHJlZml4OiAnJ1xuXHRcdFx0fTtcblx0XHR9XG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cbn1cblxubGV0IHJlcGxhY2VBY3Rpb25zOiBSZXBsYWNlQWN0aW9ucyA9IHtcblx0ZmFjdG9yeSh0aGlzOiBGYWN0b3J5TWFwLCB2YWx1ZTogRmFjdG9yeUZ1bmMsIHR5cGU6IFJlcGxhY2VUeXBlLCBmaWxlUGFyYW06IHN0cmluZywgZXhlY1Jlc3VsdDogUmVnRXhwRXhlY0FycmF5LFxuXHRcdGFzdEluZm86IFBhcnNlSW5mbywgcHJlZml4PzogYW55LCBzdWJQYXRoPzogc3RyaW5nKTogc3RyaW5nIHwgUmVwbGFjZWRSZXN1bHQgfCBudWxsIHtcblx0XHRjb25zdCBzb3VyY2VQYXRoID0gSlNPTi5zdHJpbmdpZnkodGhpcy5jb25maWcuZW5hYmxlRmFjdG9yeVBhcmFtRmlsZSA/IGZpbGVQYXJhbSA6ICcnKTtcblx0XHRjb25zdCBleGVjRmFjdG9yeSA9ICcoJyArIHZhbHVlLnRvU3RyaW5nKCkgKyAnKSgnICsgc291cmNlUGF0aCArXG5cdFx0XHRcdChleGVjUmVzdWx0ID8gJywnICsgSlNPTi5zdHJpbmdpZnkoZXhlY1Jlc3VsdCkgOiAnJykgKyAnKSc7XG5cblx0XHRpZiAodHlwZSA9PT0gUmVwbGFjZVR5cGUucnEgfHwgdHlwZSA9PT0gUmVwbGFjZVR5cGUuaW1hKSB7IC8vIGZvciByZXF1aXJlKCkgb3IgaW1wb3J0KClcblx0XHRcdHJldHVybiBleGVjRmFjdG9yeTtcblx0XHR9IGVsc2UgaWYgKHR5cGUgPT09IFJlcGxhY2VUeXBlLmltcCkge1xuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0cmVwbGFjZUFsbDogdHJ1ZSxcblx0XHRcdFx0Y29kZTogdG9Bc3NpZ25tZW50KGFzdEluZm8sIGV4ZWNGYWN0b3J5KVxuXHRcdFx0fTtcblx0XHR9XG5cdFx0cmV0dXJuIG51bGw7XG5cdH0sXG5cblx0c3Vic3RpdHV0ZSh0aGlzOiBGYWN0b3J5TWFwLCBzZXR0aW5nOiBGYWN0b3J5RnVuYyB8IHN0cmluZywgdHlwZTogUmVwbGFjZVR5cGUsIGZpbGVQYXJhbTogc3RyaW5nLCBleGVjUmVzdWx0OiBSZWdFeHBFeGVjQXJyYXksXG5cdFx0YXN0SW5mbzogUGFyc2VJbmZvLCBwcmVmaXg/OiBhbnksIHN1YlBhdGg/OiBzdHJpbmcpOiBzdHJpbmcgfCBSZXBsYWNlZFJlc3VsdCB8IG51bGwge1xuXHRcdGlmICh0eXBlID09PSBSZXBsYWNlVHlwZS5ycykgeyAvLyBmb3IgcmVxdWlyZS5lbnN1cmVcblx0XHRcdGlmIChfLmlzRnVuY3Rpb24oc2V0dGluZykpXG5cdFx0XHRcdHJldHVybiBKU09OLnN0cmluZ2lmeShzZXR0aW5nKGZpbGVQYXJhbSwgZXhlY1Jlc3VsdCkgKyBzdWJQYXRoKTtcblx0XHRcdHJldHVybiBKU09OLnN0cmluZ2lmeShzZXR0aW5nICsgc3ViUGF0aCk7XG5cdFx0fSBlbHNlIGlmICh0eXBlID09PSBSZXBsYWNlVHlwZS5ycSkge1xuXHRcdFx0aWYgKF8uaXNGdW5jdGlvbihzZXR0aW5nKSlcblx0XHRcdFx0cmV0dXJuICdyZXF1aXJlKCcgKyBKU09OLnN0cmluZ2lmeShwcmVmaXggKyBzZXR0aW5nKGZpbGVQYXJhbSwgZXhlY1Jlc3VsdCkpICsgc3ViUGF0aCArICcpJztcblx0XHRcdHJldHVybiAncmVxdWlyZSgnICsgSlNPTi5zdHJpbmdpZnkocHJlZml4ICsgc2V0dGluZyArIHN1YlBhdGgpICsgJyknO1xuXHRcdH0gZWxzZSBpZiAodHlwZSA9PT0gUmVwbGFjZVR5cGUuaW1hKSB7XG5cdFx0XHRpZiAoXy5pc0Z1bmN0aW9uKHNldHRpbmcpKVxuXHRcdFx0XHRyZXR1cm4gJ2ltcG9ydCgnICsgSlNPTi5zdHJpbmdpZnkocHJlZml4ICsgc2V0dGluZyhmaWxlUGFyYW0sIGV4ZWNSZXN1bHQpKSArIHN1YlBhdGggKyAnKSc7XG5cdFx0XHRyZXR1cm4gJ2ltcG9ydCgnICsgSlNPTi5zdHJpbmdpZnkocHJlZml4ICsgc2V0dGluZykgKyBzdWJQYXRoICsgJyknO1xuXHRcdH0gZWxzZSBpZiAodHlwZSA9PT0gUmVwbGFjZVR5cGUuaW1wKSB7XG5cdFx0XHR2YXIgcmVwbGFjZWQgPSBfLmlzRnVuY3Rpb24oc2V0dGluZykgPyBzZXR0aW5nKGZpbGVQYXJhbSwgZXhlY1Jlc3VsdCkgOiBzZXR0aW5nO1xuXHRcdFx0cmVwbGFjZWQgPSBKU09OLnN0cmluZ2lmeShwcmVmaXggKyByZXBsYWNlZCArIHN1YlBhdGgpO1xuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0cmVwbGFjZUFsbDogZmFsc2UsXG5cdFx0XHRcdGNvZGU6IHJlcGxhY2VkXG5cdFx0XHR9O1xuXHRcdH1cblx0XHRyZXR1cm4gbnVsbDtcblx0fSxcblxuXHR2YWx1ZSh0aGlzOiBGYWN0b3J5TWFwLCBzZXR0aW5nOiBGYWN0b3J5RnVuYyB8IHtyZXBsYWNlbWVudDogRmFjdG9yeUZ1bmMgfCBzdHJpbmd9LCB0eXBlOiBSZXBsYWNlVHlwZSwgZmlsZVBhcmFtOiBzdHJpbmcsIGV4ZWNSZXN1bHQ6IFJlZ0V4cEV4ZWNBcnJheSxcblx0XHRhc3RJbmZvOiBQYXJzZUluZm8sIHByZWZpeD86IGFueSwgc3ViUGF0aD86IHN0cmluZyk6IFJlcGxhY2VkUmVzdWx0IHwgc3RyaW5nIHwgbnVsbCB7XG5cdFx0aWYgKHR5cGUgPT09IFJlcGxhY2VUeXBlLnJxIHx8IHR5cGUgPT09IFJlcGxhY2VUeXBlLmltcCB8fCB0eXBlID09PSBSZXBsYWNlVHlwZS5pbWEpIHtcblx0XHRcdHZhciByZXBsYWNlZDtcblx0XHRcdGlmIChfLmhhcyhzZXR0aW5nLCAncmVwbGFjZW1lbnQnKSkge1xuXHRcdFx0XHRjb25zdCBzZXR0aW5nMSA9IHNldHRpbmcgYXMge3JlcGxhY2VtZW50OiBGYWN0b3J5RnVuY307XG5cdFx0XHRcdHJlcGxhY2VkID0gKF8uaXNGdW5jdGlvbihzZXR0aW5nMS5yZXBsYWNlbWVudCkpID9cblx0XHRcdFx0XHQoc2V0dGluZzEucmVwbGFjZW1lbnQgYXMgRmFjdG9yeUZ1bmMpKGZpbGVQYXJhbSwgZXhlY1Jlc3VsdCkgOlxuXHRcdFx0XHRcdHNldHRpbmcxLnJlcGxhY2VtZW50IGFzIGFueTtcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHJlcGxhY2VkID0gXy5pc0Z1bmN0aW9uKHNldHRpbmcpID8gSlNPTi5zdHJpbmdpZnkoc2V0dGluZyhmaWxlUGFyYW0sIGV4ZWNSZXN1bHQpKSA6XG5cdFx0XHRcdFx0SlNPTi5zdHJpbmdpZnkoc2V0dGluZyk7XG5cdFx0XHR9XG5cdFx0XHRyZXR1cm4gdHlwZSA9PT0gUmVwbGFjZVR5cGUuaW1wID8ge1xuXHRcdFx0XHRcdHJlcGxhY2VBbGw6IHRydWUsXG5cdFx0XHRcdFx0Y29kZTogdG9Bc3NpZ25tZW50KGFzdEluZm8sIHJlcGxhY2VkKVxuXHRcdFx0XHR9IDogcmVwbGFjZWQ7XG5cdFx0fVxuXHRcdHJldHVybiBudWxsO1xuXHR9LFxuXG5cdHJlcGxhY2VDb2RlKHNldHRpbmc6IEZhY3RvcnlGdW5jIHwgc3RyaW5nLCB0eXBlOiBSZXBsYWNlVHlwZSwgZmlsZVBhcmFtOiBzdHJpbmcsIGV4ZWNSZXN1bHQ6IFJlZ0V4cEV4ZWNBcnJheSxcblx0XHRhc3RJbmZvOiBQYXJzZUluZm8sIHByZWZpeD86IGFueSwgc3ViUGF0aD86IHN0cmluZyk6IFJlcGxhY2VkUmVzdWx0IHwgc3RyaW5nIHtcblx0XHR2YXIgcmVwbGFjZWQgPSBzZXR0aW5nIGFzIHN0cmluZztcblx0XHRpZiAoXy5pc0Z1bmN0aW9uKHNldHRpbmcpKVxuXHRcdFx0cmVwbGFjZWQgPSBzZXR0aW5nKGZpbGVQYXJhbSwgZXhlY1Jlc3VsdCk7XG5cdFx0cmV0dXJuIHR5cGUgPT09IFJlcGxhY2VUeXBlLmltcCA/IHtcblx0XHRcdHJlcGxhY2VBbGw6IHRydWUsXG5cdFx0XHRjb2RlOiB0b0Fzc2lnbm1lbnQoYXN0SW5mbywgcmVwbGFjZWQpXG5cdFx0fSA6IHJlcGxhY2VkO1xuXHR9LFxuXG5cdHZhcmlhYmxlKHNldHRpbmc6IHN0cmluZywgdHlwZTogUmVwbGFjZVR5cGUsIGZpbGVQYXJhbTogc3RyaW5nLCBleGVjUmVzdWx0OiBSZWdFeHBFeGVjQXJyYXksXG5cdFx0YXN0SW5mbzogUGFyc2VJbmZvKSB7XG5cdFx0aWYgKHR5cGUgPT09IFJlcGxhY2VUeXBlLnJxIHx8IHR5cGUgPT09IFJlcGxhY2VUeXBlLmltYSkge1xuXHRcdFx0cmV0dXJuIHNldHRpbmcgYXMgc3RyaW5nO1xuXHRcdH1cblx0XHRpZiAodHlwZSA9PT0gUmVwbGFjZVR5cGUuaW1wKVxuXHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0cmVwbGFjZUFsbDogdHJ1ZSxcblx0XHRcdFx0Y29kZTogdG9Bc3NpZ25tZW50KGFzdEluZm8sIHNldHRpbmcgYXMgc3RyaW5nKVxuXHRcdFx0fTtcblx0XHRyZXR1cm4gbnVsbDtcblx0fVxuXG5cdC8vIHJlc29sdmVQYXRoKGRpcjogRmFjdG9yeVNldHRpbmcsIHR5cGU6IHN0cmluZywgZmlsZVBhcmFtOiBzdHJpbmcsIGV4ZWNSZXN1bHQ6IFJlZ0V4cEV4ZWNBcnJheSxcblx0Ly8gXHRhc3RJbmZvOiBQYXJzZUluZm8pOiBzdHJpbmcge1xuXHQvLyBcdHJldHVybiBkaXIgYXMgc3RyaW5nO1xuXHQvLyB9XG59O1xuXG5leHBvcnQgaW50ZXJmYWNlIEZhY3RvcnlNYXBJbnRlcmYge1xuXHQvKipcblx0ICogUmVwbGFjaW5nIGEgcmVxdWlyZWQgbW9kdWxlIHdpdGggYSBmdW5jdGlvbiByZXR1cm5lZCB2YWx1ZS4gTm90IHdvcmtpbmcgZm9yIGByZXF1aXJlLmVuc3VyZSgpYFxuXHQgKiBAcGFyYW0gcmVxdWlyZWRNb2R1bGUgdGhlIG9yaWdpbmFsIG1vZHVsZSBuYW1lIHdoaWNoIGlzIHJlcXVpcmVkIGZvciwgaXQgY2FuJ3QgYmUgYSByZWxhdGl2ZSBmaWxlIHBhdGguXG5cdCAqIEBwYXJhbSBmYWN0b3J5RnVuYyBBIGZ1bmN0aW9uIGludm9rZWQgd2l0aCAxIGFyZ3VtZW50OiBgc291cmNlRmlsZVBhdGhgIGFuZCByZXR1cm5zIGEgdmFsdWUgd2hpY2ggdGhlbiB3aWxsIHJlcGxhY2UgdGhlIG9yaWdpbmFsIG1vZHVsZSBvZiBgcmVxdWlyZWRNb2R1bGVgLlxuXHQgKiBcblx0ICogKipOb3RlKio6IEluIGJyb3dzZXIgc2lkZSByZXBsYWNlbWVudCBtb2RlLCBpdCByZXBsYWNlcyBlbnRpcmUgYHJlcXVpcmUoJ3JlcXVpcmVkTW9kdWxlJylgIGV4cHJlc3Npb24gaW4gc291cmNlIGNvZGUgd2l0aCBJbW1lZGlhdGVseS1JbnZva2VkIEZ1bmN0aW9uIEV4cHJlc3Npb24gKElJRkUpIG9mIHRoZSBmYWN0b3J5IGZ1bmN0aW9uYC50b1N0cmluZygpYDpcblx0XHRgYGBqc1xuLy8gcmVxdWlyZSgncmVxdWlyZWRNb2R1bGUnKTsgLT5cbicoJyArIGZhY3RvcnkudG9TdHJpbmcoKSArICcpKHNvdXJjZUZpbGVQYXRoLCByZWdleHBFeGVjUmVzdWx0KSc7XG5gYGBcblx0XHQ+IEluIHJlcGxhY2VtZW50IG1vZGUsIHBhcmFtZXRlciBgc291cmNlRmlsZVBhdGhgIHdpbGwgYmUgbnVsbCBieSBkZWZhdWx0LCBzaW5jZSB0aGlzIHdvdWxkIGV4cG9zZVxuXHRcdG9yaWdpbmFsIHNvdXJjZSBmaWxlIHBhdGggb2YgeW91ciBmaWxlIHN5c3RlbSwgaWYgeW91IHN0aWxsIHdhbnQgdG8gb2J0YWluIGBzb3VyY2VGaWxlUGF0aGAsIHNldCBvcHRpb24gYC5lbmFibGVGYWN0b3J5UGFyYW1GaWxlYFxuXHRcdHRvIGB0cnVlYFxuXG5cdFx0VGhlIGZhY3RvcnkgZXZlbnR1YWxseSBzdGFuZHMgaW4gc291cmNlIGNvZGUsIG5vdCBOb2RlSlMgcnVudGltZS5cblx0XHRUaHVzIHlvdSBjYW4gbm90IGhhdmUgYW55IHJlZmVyZW5jZSB0byBhbnkgY2xvc3VyZSB2YXJpYWJsZSBpbiBmYWN0b3J5IGZ1bmN0aW9uLlxuXHQgKi9cblx0ZmFjdG9yeShyZXF1aXJlZE1vZHVsZTogc3RyaW5nIHwgUmVnRXhwLCBmYWN0b3J5RnVuYzogRmFjdG9yeUZ1bmMpOiBGYWN0b3J5TWFwSW50ZXJmO1xuXHQvKipcblx0ICogT3Jcblx0XHRgYWxpYXMocmVxdWlyZWRNb2R1bGUsIG5ld01vZHVsZSlgXG5cblx0XHRSZXBsYWNpbmcgYSByZXF1aXJlZCBtb2R1bGUgd2l0aCByZXF1aXJpbmcgYW5vdGhlciBtb2R1bGUuXG5cdFx0PiBBbHNvIHN1cHBvcnQgYG5wbTovL3BhY2thZ2VgIHJlZmVyZW5jZSBpbiBTd2lnIHRlbXBsYXRlIHRhZ3MgYGluY2x1ZGVgIGFuZCBgaW1wb3J0YCxcblx0XHRjaGVjayB0aGlzIG91dCBbc3dpZy1wYWNrYWdlLXRtcGwtbG9hZGVyIGluamVjdGlvbl0oaHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2Uvc3dpZy1wYWNrYWdlLXRtcGwtbG9hZGVyI2luamVjdGlvbilcblxuXHRcdD4gSXQgd29ya3MgdmVyeSBsaWtlICoqV2VicGFjayoqJ3MgYHJlc29sdmUuYWxpYXNgLFxuXHRcdGl0IGFsc28gbWF0Y2hlcyBtb2R1bGUgbmFtZSB3aGljaCBpcyBjb25zaXN0IG9mIG5vZGUgcGFja2FnZSBuYW1lIGFuZCBzcGVjaWZpYyBwYXRoXG5cblx0XHRlLmcuXG5cdFx0V2hlbiBpbmplY3RvciBpcyBjb25maWd1cmVkIGFzXG5cdFx0YGBganNcblx0XHRyai5mcm9tRGlyKCcuJykuYWxpYXMoJ21vZHVsZUEnLCAnbW9kdWxlQicpO1xuXHRcdGBgYFxuXHRcdFRoZW4gdGhlIGZpbGUgY29udGFpbnMgYHJlcXVpcmUoJ21vZHVsZUEvZm9vL2Jhci5qcycpYCB3aWxsIGJlIHJlcGxhY2VkIHdpdGggYHJlcXVpcmUoJ21vZHVsZUIvZm9vL2Jhci5qcycpYFxuXHQgKiBAcGFyYW0gcmVxdWlyZWRNb2R1bGUgdGhlIG9yaWdpbmFsIG1vZHVsZSBuYW1lIHdoaWNoIGlzIHJlcXVpcmVkIGZvciwgaXQgY2FuJ3QgYmUgcmVsYXRpdmUgZmlsZSBwYXRoLCBvbmx5IHN1cHBvcnRzIGFic29sdXRlIHBhdGgsIGEgcGFja2FnZSBuYW1lIG9yIFJlZ3VsYXIgRXhwcmVzc2lvbi5cblx0PiBQYWNrYWdlIG5hbWUgbGlrZSBgbG9kYXNoL3Rocm90dGxlYCBhbHNvIHdvcmtzLCBhcyBsb25nIGFzIGl0IGNhbiBiZSByZXNvbHZlZCB0byBzYW1lIGFic29sdXRlIHBhdGggYWxsIHRoZSB0aW1lLlxuXHQgKiBAcGFyYW0gbmV3TW9kdWxlIHRoZSBuZXcgbW9kdWxlIG5hbWUgdGhhdCBpcyByZXBsYWNlZCB3aXRoLlxuXHQgKiBJZiBgbmV3TW9kdWxlYCBpcyBhIGZ1bmN0aW9uLCBpdCB3aWxsIGJlIHBhc3NlZCBpbiAyIHBhcmFtZXRlcnM6IGBzb3VyY2VGaWxlUGF0aGAgYW5kIGByZWdleHBFeGVjUmVzdWx0YCwgYW5kIG11c3QgcmV0dXJuIHN0cmluZyB2YWx1ZSBvZiByZXBsYWNlZCBtb2R1bGUgbmFtZS5cblx0Ki9cblx0c3Vic3RpdHV0ZShyZXF1aXJlZE1vZHVsZTogc3RyaW5nIHwgUmVnRXhwLCBuZXdNb2R1bGU6IHN0cmluZ3wgRmFjdG9yeUZ1bmMpOiBGYWN0b3J5TWFwSW50ZXJmO1xuXHQvKipcblx0ICogUmVwbGFjaW5nIGEgcmVxdWlyZWQgbW9kdWxlIHdpdGggYW55IG9iamVjdCBvciBwcmltaXRpdmUgdmFsdWUuXG5cdFx0PiBOb3Qgd29yayBmb3IgYHJlcXVpcmUuZW5zdXJlKClgXG5cdCAqIEBwYXJhbSByZXF1aXJlZE1vZHVsZSB0aGUgb3JpZ2luYWwgbW9kdWxlIG5hbWUgd2hpY2ggaXMgcmVxdWlyZWQgZm9yLCBpdCBjYW4ndCBiZSBhIHJlbGF0aXZlIGZpbGUgcGF0aC5cblx0ICogQHBhcmFtIG5ld01vZHVsZSB0aGUgdmFsdWUgdG8gcmVwbGFjZSBgcmVxdWlyZWRNb2R1bGVgIGV4cG9ydHMuXG5cdCAqIFxuXHQgKiBXaGVuIGAuaW5qZWN0VG9GaWxlKClgIGlzIGNhbGxlZCBvciBgLnRyYW5zZm9ybWAgaXMgdXNlZCBmb3IgQnJvd3NlcmlmeSwgbWVhbmluZyBpdCBpcyBub3QgYSBOb2RlIGVudmlyb25tZW50LCB0aGUgc29sdXRpb24gaXMgYWN0dWFsbHkgcmVwbGFjaW5nIGVudGlyZSBgcmVxdWlyZSgncmVxdWlyZWRNb2R1bGUnKWDigJjigJkgZXhwcmVzc2lvbiB3aXRoIHJlc3VsdCBvZiBgSlNPTi5zdHJpbmdpZnkodmFsdWUpYC5cblx0XHRTb21ldGltZXMsIHRoZSB2YWx1ZSBpcyB2YXJpYWJsZSByZWZlcmVuY2UsXG5cdFx0eW91IHdvdWxkbid0IHdhbnQgYEpTT04uc3RyaW5naWZ5YCBmb3IgaXQsIHlvdSBjYW4gdXNlIGFuIG9iamVjdCBleHByZXNzaW9uOlxuXHRcdC0gYHtzdHJpbmd9YCBgdmFsdWUucmVwbGFjZW1lbnRgOiBUaGUgcmVwbGFjZWQgc3RyaW5nIGxpdGVyYWwgYXMgdmFyaWFibGUgZXhwcmVzc2lvbiwgc2FtZSBhcyB3aGF0IGAucmVwbGFjZUNvZGUoKWAgZG9lcy5cblx0XHQtIGB7b2JqZWN0fWAgYHZhbHVlLnZhbHVlYDogTm9kZSByZXF1aXJlIGluamVjdGlvbiB2YWx1ZVxuXHRcdGBgYGpzXG5cdFx0cmouZnJvbURpcignZGlyMScpXG5cdFx0LnZhbHVlKCdyZXBsYWNlTWUnLCB7XG5cdFx0XHRyZXBsYWNlbWVudDogJ3dpbmRvdy5qUXVlcnknLCAvLyBmb3IgQnJvd3NlcmlmeSB0cmFuc2Zvcm1cblx0XHRcdHZhbHVlOiBjaGVlcmlvICAgLy8gZm9yIE5vZGUgcmVxdWlyZSgpIGluamVjdGlvblxuXHRcdH0pXG5cdFx0YGBgXG5cdFx0SWYgYHZhbHVlYCBpcyBhIGZ1bmN0aW9uLCBpdCB3aWxsIGJlIHBhc3NlZCBpbiAyIHBhcmFtZXRlcnM6IGBzb3VyY2VGaWxlUGF0aGAgYW5kIGByZWdleHBFeGVjUmVzdWx0YCwgYW5kIG11c3QgcmV0dXJuIHNvbWUgdmFsdWUuXG5cdCovXG5cdHZhbHVlKHJlcXVpcmVkTW9kdWxlOiBzdHJpbmcgfCBSZWdFeHAsIG5ld01vZHVsZTogUmVwbGFjZVR5cGVWYWx1ZSB8IEZhY3RvcnlGdW5jIHwgYW55KTogRmFjdG9yeU1hcEludGVyZjtcblx0LyoqXG5cdCAqIFJlcGxhY2UgYG5wbTovL3BhY2thZ2VgIHJlZmVyZW5jZSBpbiBTd2lnIHRlbXBsYXRlIHRhZ3MgYGluY2x1ZGVgIGFuZCBgaW1wb3J0YCxcbmNoZWNrIHRoaXMgb3V0IFtzd2lnLXBhY2thZ2UtdG1wbC1sb2FkZXIgaW5qZWN0aW9uXShodHRwczovL3d3dy5ucG1qcy5jb20vcGFja2FnZS9zd2lnLXBhY2thZ2UtdG1wbC1sb2FkZXIjaW5qZWN0aW9uKVxuXHQgKiBAcGFyYW0gcmVxdWlyZWRNb2R1bGUgXG5cdCAqIEBwYXJhbSBkaXIgXG5cdCAqL1xuXHRzd2lnVGVtcGxhdGVEaXIocmVxdWlyZWRNb2R1bGU6IHN0cmluZywgZGlyOiBzdHJpbmcpOiBGYWN0b3J5TWFwSW50ZXJmO1xuXHQvKipcblx0ICogQXJiaXRyYXJ5IEpTIGNvZGUgcmVwbGFjZW1lbnRcblx0PiBPbmx5IHdvcmsgaW4gcmVwbGFjZW1lbnQgbW9kZSwgbm90IE5vZGVKcyBzaWRlXG5cblx0YGBganNcblx0dmFyIHJqUmVwbGFjZSA9IHJqKHtub05vZGU6IHRydWV9KTtcblx0cmpSZXBsYWNlLmZyb21QYWNrYWdlKFtwYWNrYWdlQS4uLl0pXG5cdFx0LnJlcGxhY2VDb2RlKCdmb29iYXInLCBKU09OLnN0cmluZ2lmeSh7Zm9vOiAnYmFyJ30pKTtcblx0YGBgXG5cdEluIHdoaWNoIFwiYHZhciBmb29iYXIgPSByZXF1aXJlKCdmb29iYXInKTtcImAgaXMgcmVwbGFjZWQgd2l0aDpcblx0YGBganNcblx0dmFyICBmb29iYXIgPSB7XCJmb29cIjogXCJiYXJcIn07XG5cdGBgYFxuXHQgKiBAcGFyYW0gcmVxdWlyZWRNb2R1bGUgXG5cdCAqIEBwYXJhbSBuZXdNb2R1bGUgXG5cdCAqL1xuXHRyZXBsYWNlQ29kZShyZXF1aXJlZE1vZHVsZTogc3RyaW5nIHwgUmVnRXhwLCBuZXdNb2R1bGU6IHN0cmluZ3wgRmFjdG9yeUZ1bmMpOiBGYWN0b3J5TWFwSW50ZXJmO1xuXHQvKipcblx0ICogU2FtZSBhcyBzdWJzdGl0dXRlKClcblx0ICogQHBhcmFtIHJlcXVpcmVkTW9kdWxlIFxuXHQgKiBAcGFyYW0gbmV3TW9kdWxlIFxuXHQgKi9cblx0YWxpYXMocmVxdWlyZWRNb2R1bGU6IHN0cmluZyB8IFJlZ0V4cCwgbmV3TW9kdWxlOiBzdHJpbmd8IEZhY3RvcnlGdW5jKTogRmFjdG9yeU1hcEludGVyZjtcbn1cblxubGV0IGluamVjdEFjdGlvbnM6IEluamVjdEFjdGlvbnMgPSB7XG5cdGZhY3Rvcnkoc2V0dGluZzogRmFjdG9yeVNldHRpbmcsXG5cdFx0Y2FsbGVlTW9kdWxlSWQ6IHN0cmluZyxcblx0XHRjYWxsZWVNb2R1bGU/OiBhbnksXG5cdFx0cmVxdWlyZUNhbGw/OiAobTogYW55LCBmaWxlOiBzdHJpbmcpID0+IEZhY3RvcnlTZXR0aW5nLFxuXHRcdHN1YlBhdGg/OiBzdHJpbmcpIHtcblx0XHRpZiAoXy5pc0Z1bmN0aW9uKHNldHRpbmcpKSB7XG5cdFx0XHRyZXR1cm4gc2V0dGluZyhjYWxsZWVNb2R1bGVJZCk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdHJldHVybiBzZXR0aW5nO1xuXHRcdH1cblx0fSxcblxuXHR2YWx1ZShzZXR0aW5nOiBGYWN0b3J5U2V0dGluZyxcblx0XHRjYWxsZWVNb2R1bGVJZDogc3RyaW5nLFxuXHRcdGNhbGxlZU1vZHVsZTogYW55LFxuXHRcdHJlcXVpcmVDYWxsOiAobTogYW55LCBmaWxlOiBzdHJpbmcpID0+IEZhY3RvcnlTZXR0aW5nLFxuXHRcdHN1YlBhdGg/OiBzdHJpbmcpIHtcblx0XHRpZiAoXy5oYXMoc2V0dGluZywgJ3ZhbHVlJykpXG5cdFx0XHRyZXR1cm4gc2V0dGluZy52YWx1ZTtcblx0XHRlbHNlXG5cdFx0XHRyZXR1cm4gc2V0dGluZztcblx0fSxcblxuXHRyZXBsYWNlQ29kZShzZXR0aW5nOiBGYWN0b3J5U2V0dGluZyxcblx0XHRjYWxsZWVNb2R1bGVJZDogc3RyaW5nLFxuXHRcdGNhbGxlZU1vZHVsZTogYW55LFxuXHRcdHJlcXVpcmVDYWxsOiAobTogYW55LCBmaWxlOiBzdHJpbmcpID0+IEZhY3RvcnlTZXR0aW5nLFxuXHRcdHN1YlBhdGg/OiBzdHJpbmcpOiBhbnkge1xuXHRcdC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1jb25zb2xlXG5cdFx0Y29uc29sZS5sb2coJ3JlcXVpcmUtaW5qZWN0b3IgZG9lcyBub3Qgc3VwcG9ydCBcInJlcGxhY2VDb2RlKClcIiBmb3IgTm9kZUpTIGVudmlyb25tZW50Jyk7XG5cdH0sXG5cblx0c3Vic3RpdHV0ZShzZXR0aW5nOiBhbnksIGNhbGxlZU1vZHVsZUlkOiBzdHJpbmcsIGNhbGxlZU1vZHVsZTogYW55LFxuXHRcdHJlcXVpcmVDYWxsOiAobTogYW55LCBmaWxlOiBzdHJpbmcpID0+IEZhY3RvcnlTZXR0aW5nLCBzdWJQYXRoPzogc3RyaW5nKSB7XG5cdFx0cmV0dXJuIHJlcXVpcmVDYWxsLmNhbGwoY2FsbGVlTW9kdWxlLCBzZXR0aW5nICsgc3ViUGF0aCk7XG5cdH0sXG5cblx0dmFyaWFibGUoc2V0dGluZzogRmFjdG9yeVNldHRpbmcsXG5cdFx0Y2FsbGVlTW9kdWxlSWQ6IHN0cmluZyxcblx0XHRjYWxsZWVNb2R1bGU/OiBhbnksXG5cdFx0cmVxdWlyZUNhbGw/OiAobTogYW55LCBmaWxlOiBzdHJpbmcpID0+IEZhY3RvcnlTZXR0aW5nLFxuXHRcdHN1YlBhdGg/OiBzdHJpbmcpIHtcblx0XHRyZXR1cm4gc2V0dGluZztcblx0fVxufTtcblxuZXhwb3J0IGNsYXNzIEZhY3RvcnlNYXBDb2xsZWN0aW9uIGltcGxlbWVudHMgRmFjdG9yeU1hcEludGVyZiB7XG5cdG1hcHM6IEZhY3RvcnlNYXBJbnRlcmZbXTtcblx0Y29uc3RydWN0b3IobWFwczogRmFjdG9yeU1hcEludGVyZltdKSB7XG5cdFx0dGhpcy5tYXBzID0gbWFwcztcblx0fVxuXHRmYWN0b3J5KHJlcXVpcmVkTW9kdWxlOiBzdHJpbmcgfCBSZWdFeHAsIGZhY3RvcnlGdW5jOiBGYWN0b3J5RnVuYyk6IEZhY3RvcnlNYXBJbnRlcmYge1xuXHRcdHJldHVybiB0aGlzLl9hZGRTZXR0aW5nKCdmYWN0b3J5JywgcmVxdWlyZWRNb2R1bGUsIGZhY3RvcnlGdW5jKTtcblx0fVxuXG5cdHN1YnN0aXR1dGUocmVxdWlyZWRNb2R1bGU6IHN0cmluZyB8IFJlZ0V4cCwgbmV3TW9kdWxlOiBzdHJpbmd8IEZhY3RvcnlGdW5jKTogRmFjdG9yeU1hcEludGVyZiB7XG5cdFx0cmV0dXJuIHRoaXMuX2FkZFNldHRpbmcoJ3N1YnN0aXR1dGUnLCByZXF1aXJlZE1vZHVsZSwgbmV3TW9kdWxlKTtcblx0fVxuXHR2YWx1ZShyZXF1aXJlZE1vZHVsZTogc3RyaW5nIHwgUmVnRXhwLCBuZXdNb2R1bGU6IGFueXwgRmFjdG9yeUZ1bmMpOiBGYWN0b3J5TWFwSW50ZXJmIHtcblx0XHRyZXR1cm4gdGhpcy5fYWRkU2V0dGluZygndmFsdWUnLCByZXF1aXJlZE1vZHVsZSwgbmV3TW9kdWxlKTtcblx0fVxuXG5cdHN3aWdUZW1wbGF0ZURpcihyZXF1aXJlZE1vZHVsZTogc3RyaW5nLCBkaXI6IHN0cmluZyk6IEZhY3RvcnlNYXBJbnRlcmYge1xuXHRcdHJldHVybiB0aGlzLl9hZGRTZXR0aW5nKCdzd2lnVGVtcGxhdGVEaXInLCByZXF1aXJlZE1vZHVsZSwgZGlyKTtcblx0fVxuXG5cdHJlcGxhY2VDb2RlKHJlcXVpcmVkTW9kdWxlOiBzdHJpbmcgfCBSZWdFeHAsIG5ld01vZHVsZTogc3RyaW5nfCBGYWN0b3J5RnVuYyk6IEZhY3RvcnlNYXBJbnRlcmYge1xuXHRcdHJldHVybiB0aGlzLl9hZGRTZXR0aW5nKCdyZXBsYWNlQ29kZScsIHJlcXVpcmVkTW9kdWxlLCBuZXdNb2R1bGUpO1xuXHR9XG5cblx0YWxpYXMocmVxdWlyZWRNb2R1bGU6IHN0cmluZyB8IFJlZ0V4cCwgbmV3TW9kdWxlOiBzdHJpbmd8IEZhY3RvcnlGdW5jKTogRmFjdG9yeU1hcEludGVyZiB7XG5cdFx0cmV0dXJuIHRoaXMuX2FkZFNldHRpbmcoJ3N1YnN0aXR1dGUnLCByZXF1aXJlZE1vZHVsZSwgbmV3TW9kdWxlKTtcblx0fVxuXHRwcm90ZWN0ZWQgX2FkZFNldHRpbmcodGhpczogRmFjdG9yeU1hcENvbGxlY3Rpb24sIG1ldGhvZDogc3RyaW5nLCByZXF1aXJlZE1vZHVsZTogc3RyaW5nIHwgUmVnRXhwLCBuZXdNb2R1bGU6IHN0cmluZ3wgRmFjdG9yeUZ1bmMpOiBGYWN0b3J5TWFwSW50ZXJmIHtcblx0XHRmb3IgKGNvbnN0IGZhY3RvcnlNYXAgb2YgdGhpcy5tYXBzKSB7XG5cdFx0XHQoZmFjdG9yeU1hcCBhcyBGYWN0b3J5TWFwKS5fYWRkU2V0dGluZyhtZXRob2QsIHJlcXVpcmVkTW9kdWxlLCBuZXdNb2R1bGUpO1xuXHRcdH1cblx0XHRyZXR1cm4gdGhpcztcblx0fVxufVxuXG4iXX0=